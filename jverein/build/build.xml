<?xml version="1.0" encoding="ISO-8859-1"?>

<project basedir=".." default="all" name="All">

  <target name="init" description="inits the build">

    <property environment="env"/>
    <property name="define.pluginname"   value="jverein"/>
  	<echo>message="${define.pluginname}"</echo>
    <property name="define.jarfilename"  value="${define.pluginname}.jar"/>
    <property name="define.srcfilename"  value="${define.pluginname}.src.zip"/>
    <property name="define.package"      value="de.jost_net.JVerein"/>
    <property name="build.dir"           value="build"/>
    <buildnumber file="${build.dir}/BUILD"/>
       <loadfile property="version" srcFile="${build.dir}/RELEASE">
         <filterchain>
           <striplinebreaks/>
         </filterchain>
       </loadfile>
    <property name="project.release"     value="releases/${version}-${build.number}/${define.pluginname}"/>
    <property name="project.src" 	value="${project.release}/src/classes"/>
    <property name="project.tmp" 	value="${project.release}/tmp"/>
    <property name="project.javadoc" value="${project.release}/javadoc"/>
    <property name="src.dir" 	value="src"/>
    <property name="icon.dir"	value="${src.dir}/img"/>
    <property name="lang.dir"	value="${src.dir}/lang"/>
    <property name="help.dir"	value="${src.dir}/help"/>
    <property name="lib.dir" 	value="lib"/>
    <property name="sql.dir" 	value="sql"/>
    <property name="sql.mckoi.dir" 	value="sql.mckoi"/>
    <property name="sql.h2.dir" 	value="sql.h2"/>
    <property name="web.dir"	value="web"/>
    <property name="class.dir" 	value="bin"/>
    <property name="project.zipdir"	value="${project.release}/${define.pluginname}"/>
    <property name="project.zipfilename"   value="${define.pluginname}.zip"/>
    <path id="compilepath">
		  <pathelement location="../jameica/lib/swt/linux/swt.jar"/>
		  <pathelement location="../jameica/bin/"/>
		  <pathelement location="../hibiscus/bin/"/>
		  <fileset dir="../jameica/lib/de_willuhn_ds/">
        <include name="*.jar"/>
      </fileset>
      <fileset dir="../jameica/lib/de_willuhn_util/">
        <include name="*.jar"/>
      </fileset>
      <fileset dir="../hibiscus/lib/">
        <include name="*.jar"/>
      </fileset>
    </path>
  </target>

  <target name="cvstag"  description="tags the source in the CVS">
    <exec executable="cvs" failonerror="true" dir="${basedir}">
      <arg line="tag ${version}_BUILD_${build.number}"/>
    </exec>
  </target>

  <target name="jar" description="generates the jar file">
    <mkdir dir="${project.release}"/>
    <mkdir dir="${project.zipdir}"/>
    <jar destfile="${project.zipdir}/${define.jarfilename}">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Implementation-Title" value="${define.pluginname}"/>
        <attribute name="Implementation-Version" value="${version}"/>
        <attribute name="Implementation-Buildnumber" value="${build.number}"/>
        <attribute name="Class-Path" value="lang help lib"/>
      </manifest>
      <fileset dir="${class.dir}"/>
		</jar>
    <mkdir dir="${project.zipdir}/sql"/>
    <copy todir="${project.zipdir}/sql">
      <fileset dir="${sql.dir}"/>
    </copy>
    <mkdir dir="${project.zipdir}/sql.mckoi"/>
    <copy todir="${project.zipdir}/sql.mckoi">
      <fileset dir="${sql.mckoi.dir}"/>
    </copy>
    <mkdir dir="${project.zipdir}/sql.h2"/>
    <copy todir="${project.zipdir}/sql.h2">
      <fileset dir="${sql.h2.dir}"/>
    </copy>
    <mkdir dir="${project.zipdir}/lib" />
    <copy todir="${project.zipdir}/lib">
      <fileset dir="${lib.dir}" />
    </copy>
  	<copy todir="${project.zipdir}" file="plugin.xml" />
    <!-- Jetzt muessen wir noch das ZIP-File erzeugen -->
    <zip destfile="${project.release}/${project.zipfilename}">
      <fileset dir="${project.release}">
        <include name="${define.pluginname}"/>
        <include name="${define.pluginname}/**"/>
      </fileset>
    </zip>
  </target>

  <target name="javadoc" depends="jar" description="creates the api doc">
    <mkdir dir="${project.javadoc}"/>
    <javadoc destdir="${project.javadoc}" packagenames="${define.package}.*">
      <classpath refid="compilepath" />
      <sourcepath>
        <pathelement location="${src.dir}"/>
      </sourcepath>
    </javadoc>
  </target>

  <target name="src" description="build source package, depends compile target to make sure, the code has no errors">
    <mkdir dir="${project.release}"/>
    <mkdir dir="${project.tmp}/${define.pluginname}" />
    <copy todir="${project.tmp}/${define.pluginname}">
      <fileset dir=".">
        <include name=".project" />
        <include name=".classpath" />
        <include name="${src.dir}/**" />
        <include name="${sql.dir}/**" />
        <include name="${build.dir}/**" />
        <exclude name="${build.dir}/BUILD" />
      </fileset>
    </copy>
    <zip casesensitive="true" zipfile="${project.release}/${define.srcfilename}">
      <fileset dir="${project.tmp}">
        <include name="${define.pluginname}/**" />
      </fileset>
		</zip>
  </target>

  <target name="clean" description="cleanup">
  	<delete dir="${project.tmp}"/>
  </target>

  <target depends="init,cvstag,jar,javadoc,src,clean" description="build an official release" name="all" />

  <target name="fast" depends="init,jar,src" description="build inofficial release"  />
	
</project>
